<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev-War Bingo - AI Warriors Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5a67a, #f2c8a8);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #f5a67a;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            letter-spacing: 8px;
            margin-bottom: 10px;
        }

        .header h2 {
            font-size: 1.8rem;
            font-weight: bold;
            letter-spacing: 4px;
            margin-bottom: 20px;
        }

        .header h3 {
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 6px;
            margin-bottom: 10px;
            color: #ff9999;
        }

        .header h4 {
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 4px;
        }

        .game-setup {
            padding: 20px;
            text-align: center;
            background: #fdf2ed;
        }

        .mode-selection {
            display: block;
        }

        .form-section {
            display: none;
            margin-top: 20px;
        }

        .game-container {
            display: none;
            padding: 15px;
        }

        .player-info {
            background: #fdf2ed;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .player-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f5a67a;
            margin-bottom: 8px;
        }

        .game-id {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
        }

        .progress-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .player-status {
            padding: 8px 12px;
            background: #f5a67a;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            text-align: center;
            position: relative;
        }

        .player-status.current-player {
            background: #4CAF50;
        }

        .player-status.opponent {
            background: #ff6b6b;
        }

        .player-status.winner {
            background: #FFD700;
            color: #333;
            animation: pulse 1s infinite;
        }

        .player-progress {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #ff6b6b;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #f5a67a;
        }

        .input-group input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #f5a67a;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
        }

        .btn {
            display: inline-block;
            margin: 8px;
            padding: 12px 24px;
            background: #f5a67a;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #e89660;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
            margin: 3px;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .game-controls {
            text-align: center;
            margin-bottom: 15px;
        }

        .sync-status {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 8px 0;
            display: inline-block;
        }

        .sync-status.disconnected {
            background: #ffebee;
            color: #c62828;
        }

        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-width: 600px;
            margin: 0 auto;
            padding: 15px;
        }

        .bingo-square {
            aspect-ratio: 1;
            border: 3px solid #f5a67a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 6px;
            background: white;
            position: relative;
        }

        .bingo-square:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .bingo-square.my-mark {
            background: #4CAF50;
            color: white;
            border-color: #388E3C;
        }

        .bingo-square.opponent-mark {
            background: #ff6b6b;
            color: white;
            border-color: #ff5252;
        }

        .bingo-square.both-marked {
            background: linear-gradient(45deg, #4CAF50 50%, #ff6b6b 50%);
            color: white;
            border-color: #333;
        }

        .bingo-square.row-complete {
            box-shadow: 0 0 0 3px #FFD700;
        }

        .status {
            text-align: center;
            margin: 15px 0;
            font-size: 1.1rem;
            font-weight: bold;
            line-height: 1.4;
        }

        .win-message, .lose-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 90vw;
        }

        .win-message {
            background: #4CAF50;
        }

        .lose-message {
            background: #ff6b6b;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.8rem;
            color: #666;
            font-family: monospace;
        }

        .leaderboard {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .leaderboard h3 {
            color: #f5a67a;
            margin-bottom: 10px;
            text-align: center;
        }

        .leader-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .leader-item:last-child {
            border-bottom: none;
        }

        .leader-rank {
            font-weight: bold;
            color: #f5a67a;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
                letter-spacing: 4px;
            }
            
            .header h2 {
                font-size: 1.2rem;
                letter-spacing: 2px;
            }
            
            .header h3 {
                font-size: 1.8rem;
                letter-spacing: 3px;
            }
            
            .header h4 {
                font-size: 1.3rem;
                letter-spacing: 2px;
            }

            .bingo-square {
                font-size: 0.6rem;
                padding: 3px;
            }

            .bingo-grid {
                gap: 6px;
                padding: 10px;
            }

            .players-list {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 8px;
            }

            .player-status {
                font-size: 0.7rem;
                padding: 6px 8px;
            }

            .btn {
                padding: 10px 20px;
                font-size: 1rem;
            }

            .btn-small {
                padding: 5px 10px;
                font-size: 0.8rem;
            }

            .notification {
                max-width: 250px;
                padding: 12px 16px;
            }
        }

        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 10px;
            }

            .header {
                padding: 15px 10px;
            }

            .bingo-square {
                font-size: 0.5rem;
                padding: 2px;
            }

            .bingo-grid {
                gap: 4px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>INNODAYVOYAGERS</h1>
            <h2>SURGE 2025 ‚Äî PHASE 1 SPRINT</h2>
            <h3>DEV-WAR BINGO</h3>
            <h4>AI WARRIORS EDITION</h4>
        </div>

        <div class="game-setup" id="gameSetup">
            <!-- Mode Selection -->
            <div class="mode-selection" id="modeSelection">
                <h3 style="margin-bottom: 20px; color: #f5a67a;">Choose Your Action</h3>
                <p style="margin-bottom: 15px; color: #666;">üéØ <strong>Traditional Bingo:</strong> Mark what you've done, get 5 in a row to win!</p>
                <button class="btn" onclick="showCreateGameForm()">üÜï Create New Game</button>
                <button class="btn" onclick="showJoinGameForm()">üéÆ Join Existing Game</button>
            </div>

            <!-- Create Game Form -->
            <div class="form-section" id="createGameForm">
                <h3 style="margin-bottom: 20px; color: #f5a67a;">Create New Game</h3>
                <div class="input-group">
                    <label for="createPlayerName">Your Name:</label>
                    <input type="text" id="createPlayerName" placeholder="Enter your name" maxlength="20">
                </div>
                <button class="btn" onclick="createGame()">üöÄ Start Game</button>
                <button class="btn btn-secondary" onclick="goBackToModeSelection()">‚Üê Back</button>
            </div>

            <!-- Join Game Form -->
            <div class="form-section" id="joinGameForm">
                <h3 style="margin-bottom: 20px; color: #f5a67a;">Join Existing Game</h3>
                <div class="input-group">
                    <label for="joinPlayerName">Your Name:</label>
                    <input type="text" id="joinPlayerName" placeholder="Enter your name" maxlength="20">
                </div>
                <div class="input-group">
                    <label for="gameCode">Game Code:</label>
                    <input type="text" id="gameCode" placeholder="Enter 6-letter game code" maxlength="6" style="text-transform: uppercase;">
                </div>
                <button class="btn" onclick="joinGame()">üéØ Join Game</button>
                <button class="btn btn-secondary" onclick="goBackToModeSelection()">‚Üê Back</button>
            </div>
        </div>

        <div class="game-container" id="gameContainer">
            <div class="player-info">
                <div class="player-name" id="currentPlayerName"></div>
                <div class="game-id" id="currentGameId"></div>
                <div class="sync-status" id="syncStatus">üî• Connecting...</div>
                
                <!-- Progress Info -->
                <div class="progress-info" id="progressInfo">
                    <div id="myProgress">Squares Marked: 0/25</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="players-list" id="playersList"></div>
            </div>

            <!-- Leaderboard -->
            <div class="leaderboard" id="leaderboard" style="display: none;">
                <h3>üèÜ Players</h3>
                <div id="leaderboardList"></div>
            </div>

            <!-- Debug info for testing -->
            <div class="debug-info" id="debugInfo" style="display: none;"></div>

            <div class="game-controls">
                <button class="btn btn-small" onclick="resetGame()">üîÑ Reset Game</button>
                <button class="btn btn-small" onclick="leaveGame()">üö™ Leave Game</button>
                <button class="btn btn-small" onclick="toggleDebug()">üîç Debug</button>
                <div class="status" id="statusText">Waiting for Firebase...</div>
            </div>

            <div class="bingo-grid" id="bingoGrid"></div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="win-message" id="winMessage">
        üéâ BINGO! üéâ<br>
        <small style="font-size: 1rem;">You got 5 in a row!</small>
        <br><br>
        <button class="btn btn-small" onclick="hideMessages()">Play Again</button>
    </div>
    <div class="lose-message" id="loseMessage">
        üò¢ Game Over<br>
        <small style="font-size: 1rem;">Someone else got BINGO!</small>
        <br><br>
        <button class="btn btn-small" onclick="hideMessages()">Play Again</button>
    </div>

    <!-- Notification popup -->
    <div class="notification" id="notification"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCRGQDgi2B4T5R-HPkx__fWvj4rh0DUiZE",
            authDomain: "as-mobiles-inventory.firebaseapp.com",
            databaseURL: "https://as-mobiles-inventory-default-rtdb.firebaseio.com/",
            projectId: "as-mobiles-inventory",
            storageBucket: "as-mobiles-inventory.firebasestorage.app",
            messagingSenderId: "346993698201",
            appId: "1:346993698201:web:c111b6edff1c79706c9f08",
            measurementId: "G-QK8FG5PCTW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseRemove = remove;
        
        // Initialize game after Firebase is ready
        console.log('üî• Firebase initialized successfully!');
        window.firebaseReady = true;
        window.initializeGame();
    </script>

    <script>
        // Game Variables
        let currentPlayer = null;
        let currentGameId = null;
        let gameState = {
            players: {},
            gameStarted: false,
            winner: null,
            lastUpdate: Date.now(),
            maxPlayers: 50,
            gamePhase: 'collection', // 'collection' or 'analysis' or 'finished'
            playersReady: []
        };
        let firebaseListener = null;
        let debugMode = false;

        // Bingo squares content
        const bingoSquares = [
            "100+ GitHub Commits",
            "Built 5+ Projects", 
            "Python Pro?",
            "Hosted a Tech Session",
            "Used TensorFlow or PyTorch",
            "Attended 3+ Conferences",
            "Frontend + Backend Projects",
            "AI-based App Deployed",
            "Spoke at an Event",
            "Won a Hackathon",
            "GitHub Starred Projects",
            "Real Users Using Your App",
            "Developed a Chatbot",
            "DSA 150+ Problems Solved",
            "Blogger / Wrote Tech Article",
            "Participated in 3+ Hackathons",
            "Contributed to Open Source",
            "Published Research Paper",
            "Created Personal Portfolio",
            "Used Streamlit / Flask / Django/FastAPI",
            "ML Model Trained on Custom Dataset",
            "Made a YouTube Tutorial",
            "Presented at College Event",
            "GitHub Repos 15+",
            "Used Hugging Face"
        ];

        // Initialize game when Firebase is ready
        window.initializeGame = function() {
            console.log('üéÆ Game initialized!');
            updateSyncStatus(true);
        };

        // Utility Functions
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugMode ? 'block' : 'none';
            if (debugMode) updateDebugInfo();
        }

        function updateDebugInfo() {
            if (!debugMode) return;
            const debugInfo = document.getElementById('debugInfo');
            const playerCount = Object.keys(gameState.players).length;
            const myProgress = gameState.players[currentPlayer]?.markedSquares?.length || 0;
            const readyCount = gameState.playersReady?.length || 0;
            
            debugInfo.innerHTML = `
                <strong>üî• Traditional Bingo Debug:</strong><br>
                üåê Firebase: ${window.firebaseReady ? '‚úÖ Connected' : '‚ùå Disconnected'}<br>
                üë§ Player: ${currentPlayer || 'None'}<br>
                üéÆ Game ID: ${currentGameId || 'None'}<br>
                üë• Total Players: ${playerCount}/50<br>
                üìä My Progress: ${myProgress}/25<br>
                üèÅ Phase: ${gameState.gamePhase}<br>
                ‚úÖ Players Ready: ${readyCount}/${playerCount}<br>
                üü© My squares: ${JSON.stringify(gameState.players[currentPlayer]?.markedSquares || [])}<br>
                ‚è∞ Last update: ${new Date(gameState.lastUpdate).toLocaleTimeString()}<br>
                üëÇ Listener: ${firebaseListener ? '‚úÖ Active' : '‚ùå Inactive'}
            `;
        }

        function updateSyncStatus(connected) {
            const syncStatus = document.getElementById('syncStatus');
            if (connected && window.firebaseReady) {
                syncStatus.textContent = 'üî• Firebase Ready';
                syncStatus.className = 'sync-status';
            } else {
                syncStatus.textContent = '‚è≥ Connecting...';
                syncStatus.className = 'sync-status disconnected';
            }
        }

        // Form Functions
        function showCreateGameForm() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('createGameForm').style.display = 'block';
            document.getElementById('createPlayerName').focus();
        }

        function showJoinGameForm() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('joinGameForm').style.display = 'block';
            document.getElementById('joinPlayerName').focus();
        }

        function goBackToModeSelection() {
            document.getElementById('createGameForm').style.display = 'none';
            document.getElementById('joinGameForm').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';
            
            // Clear forms
            document.getElementById('createPlayerName').value = '';
            document.getElementById('joinPlayerName').value = '';
            document.getElementById('gameCode').value = '';
        }

        function generateGameId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Firebase Functions
        function saveGameState() {
            if (!window.firebaseReady || !currentGameId) {
                console.error('Firebase not ready or no game ID');
                return;
            }
            
            try {
                gameState.lastUpdate = Date.now();
                const gameRef = window.firebaseRef(window.firebaseDB, `bingo-games/${currentGameId}`);
                
                window.firebaseSet(gameRef, gameState).then(() => {
                    console.log('‚úÖ Game saved to Firebase successfully');
                    updateSyncStatus(true);
                }).catch((error) => {
                    console.error('‚ùå Firebase save error:', error);
                    showNotification('Save failed: ' + error.message, true);
                });
                
                if (debugMode) updateDebugInfo();
            } catch (e) {
                console.error('Failed to save to Firebase:', e);
                showNotification('Save failed - check connection', true);
            }
        }

        function setupFirebaseListener() {
            if (!window.firebaseReady || !currentGameId) return;
            
            try {
                // Remove existing listener
                if (firebaseListener) {
                    firebaseListener();
                }
                
                const gameRef = window.firebaseRef(window.firebaseDB, `bingo-games/${currentGameId}`);
                firebaseListener = window.firebaseOnValue(gameRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.lastUpdate > gameState.lastUpdate) {
                        console.log('üîÑ Firebase update received:', data);
                        handleGameUpdate(data);
                    }
                });
                
                console.log('üëÇ Firebase listener setup for game:', currentGameId);
                updateSyncStatus(true);
            } catch (e) {
                console.error('Failed to setup Firebase listener:', e);
                showNotification('Real-time sync failed', true);
            }
        }

        function handleGameUpdate(newGameState) {
            const oldPlayers = Object.keys(gameState.players);
            const oldPhase = gameState.gamePhase;
            
            gameState = newGameState;
            const newPlayers = Object.keys(gameState.players);
            
            // Check for new players
            const joinedPlayers = newPlayers.filter(p => !oldPlayers.includes(p) && p !== currentPlayer);
            if (joinedPlayers.length > 0) {
                showNotification(`üéâ ${joinedPlayers.join(', ')} joined!`);
            }
            
            // Check for players who left
            const leftPlayers = oldPlayers.filter(p => !newPlayers.includes(p) && p !== currentPlayer);
            if (leftPlayers.length > 0) {
                showNotification(`üëã ${leftPlayers.join(', ')} left`, true);
            }
            
            // Check for phase changes
            if (oldPhase !== gameState.gamePhase) {
                if (gameState.gamePhase === 'analysis') {
                    showNotification('üîç Analysis phase started!');
                } else if (gameState.gamePhase === 'finished') {
                    showNotification('üèÅ Game finished!');
                }
            }
            
            updateUI();
        }

        // Game Functions
        function createGame() {
            const playerName = document.getElementById('createPlayerName').value.trim();
            if (!playerName) {
                showNotification('Please enter your name', true);
                return;
            }

            if (!window.firebaseReady) {
                showNotification('Connecting to Firebase...', true);
                setTimeout(createGame, 1000);
                return;
            }

            currentGameId = generateGameId();
            currentPlayer = playerName;
            
            gameState = {
                players: {},
                gameStarted: true,
                winner: null,
                lastUpdate: Date.now(),
                maxPlayers: 50,
                gamePhase: 'collection',
                playersReady: []
            };
            gameState.players[currentPlayer] = { 
                markedSquares: [], 
                isWinner: false, 
                joinedAt: Date.now(),
                isReady: false
            };

            saveGameState();
            setupFirebaseListener();
            startGame();
            showNotification(`üéÆ Game created! Code: ${currentGameId}`);
        }

        function joinGame() {
            const playerName = document.getElementById('joinPlayerName').value.trim();
            const gameCode = document.getElementById('gameCode').value.trim().toUpperCase();
            
            if (!playerName || !gameCode) {
                showNotification('Please enter name and game code', true);
                return;
            }

            if (gameCode.length !== 6) {
                showNotification('Game code must be 6 characters', true);
                return;
            }

            if (!window.firebaseReady) {
                showNotification('Connecting to Firebase...', true);
                setTimeout(joinGame, 1000);
                return;
            }

            currentPlayer = playerName;
            currentGameId = gameCode;

            // Check if game exists and has space
            const gameRef = window.firebaseRef(window.firebaseDB, `bingo-games/${currentGameId}`);
            window.firebaseOnValue(gameRef, (snapshot) => {
                const existingGame = snapshot.val();
                
                if (existingGame) {
                    const playerCount = Object.keys(existingGame.players).length;
                    
                    if (playerCount >= 50 && !existingGame.players[currentPlayer]) {
                        showNotification('Game is full! Maximum 50 players allowed.', true);
                        return;
                    }
                    
                    gameState = existingGame;
                    
                    if (!gameState.players[currentPlayer]) {
                        gameState.players[currentPlayer] = { 
                            markedSquares: [], 
                            isWinner: false, 
                            joinedAt: Date.now(),
                            isReady: false
                        };
                        
                        const otherCount = Object.keys(gameState.players).length - 1;
                        showNotification(`üéâ Joined! ${otherCount} other player(s) in game`);
                    } else {
                        showNotification(`üîÑ Rejoined game ${currentGameId}!`);
                    }
                } else {
                    // Create new game
                    gameState = {
                        players: {},
                        gameStarted: true,
                        winner: null,
                        lastUpdate: Date.now(),
                        maxPlayers: 50,
                        gamePhase: 'collection',
                        playersReady: []
                    };
                    gameState.players[currentPlayer] = { 
                        markedSquares: [], 
                        isWinner: false, 
                        joinedAt: Date.now(),
                        isReady: false
                    };
                    showNotification(`üÜï Created new game ${currentGameId}`);
                }

                saveGameState();
                setupFirebaseListener();
                startGame();
            }, { onlyOnce: true });
        }

        function startGame() {
            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            
            document.getElementById('currentPlayerName').textContent = `Player: ${currentPlayer}`;
            document.getElementById('currentGameId').textContent = `Game Code: ${currentGameId}`;
            
            createBingoGrid();
            updateUI();
        }

        function createBingoGrid() {
            const grid = document.getElementById('bingoGrid');
            grid.innerHTML = '';
            
            bingoSquares.forEach((text, index) => {
                const square = document.createElement('div');
                square.className = 'bingo-square';
                square.textContent = text;
                square.dataset.index = index;
                
                square.addEventListener('click', () => handleSquareClick(index));
                grid.appendChild(square);
            });
        }

        function handleSquareClick(index) {
            // Don't allow clicks during analysis or after game finished
            if (gameState.gamePhase !== 'collection') {
                showNotification('Collection phase is over!', true);
                return;
            }

            const playerData = gameState.players[currentPlayer];
            if (!playerData) {
                console.error('Player data not found:', currentPlayer);
                showNotification('Player data error - try rejoining', true);
                return;
            }
            
            // Ensure markedSquares array exists
            if (!playerData.markedSquares) {
                playerData.markedSquares = [];
            }
            
            const markedSquares = playerData.markedSquares;
            
            if (markedSquares.includes(index)) {
                // Unmark square
                const squareIndex = markedSquares.indexOf(index);
                markedSquares.splice(squareIndex, 1);
                console.log('üü© Unmarked square:', index);
            } else {
                // Mark square
                markedSquares.push(index);
                console.log('üü© Marked square:', index);
            }

            // Immediately update UI
            updateUI();
            
            // Save to Firebase
            saveGameState();
            
            // NO IMMEDIATE WIN CHECK - only during analysis phase
        }

        function markPlayerReady() {
            if (gameState.gamePhase !== 'collection') return;
            
            const playerData = gameState.players[currentPlayer];
            if (!playerData) return;
            
            playerData.isReady = true;
            
            // Add to ready list if not already there
            if (!gameState.playersReady) gameState.playersReady = [];
            if (!gameState.playersReady.includes(currentPlayer)) {
                gameState.playersReady.push(currentPlayer);
            }
            
            // Check if all players are ready
            const totalPlayers = Object.keys(gameState.players).length;
            const readyPlayers = gameState.playersReady.length;
            
            if (readyPlayers === totalPlayers && totalPlayers > 0) {
                // Start analysis phase
                gameState.gamePhase = 'analysis';
                showNotification('üîç All players ready! Starting analysis...');
                
                // Analyze after a short delay
                setTimeout(() => {
                    analyzeResults();
                }, 2000);
            }
            
            saveGameState();
            updateUI();
        }

        function analyzeResults() {
            console.log('üîç Analyzing all player results...');
            
            const winners = [];
            
            // Check each player for bingo patterns
            for (const [playerName, playerData] of Object.entries(gameState.players)) {
                if (checkForWin(playerData.markedSquares || [])) {
                    winners.push(playerName);
                    playerData.isWinner = true;
                }
            }
            
            // Set game phase to finished
            gameState.gamePhase = 'finished';
            
            if (winners.length > 0) {
                gameState.winner = winners[0]; // First winner found
                
                if (winners.includes(currentPlayer)) {
                    showNotification('üéâ BINGO! You won!');
                    showWinMessage();
                } else {
                    showNotification(`üèÜ ${winners.join(', ')} won with BINGO!`);
                    showLoseMessage();
                }
            } else {
                showNotification('üò¢ No BINGO patterns found! Try again!');
            }
            
            saveGameState();
            updateUI();
        }

        function checkForWin(markedSquares) {
            // Traditional bingo patterns: 5 in a row (horizontal, vertical, diagonal)
            const winPatterns = [
                // Rows
                [0, 1, 2, 3, 4], [5, 6, 7, 8, 9], [10, 11, 12, 13, 14], [15, 16, 17, 18, 19], [20, 21, 22, 23, 24],
                // Columns  
                [0, 5, 10, 15, 20], [1, 6, 11, 16, 21], [2, 7, 12, 17, 22], [3, 8, 13, 18, 23], [4, 9, 14, 19, 24],
                // Diagonals
                [0, 6, 12, 18, 24], [4, 8, 12, 16, 20]
            ];

            return winPatterns.some(pattern => 
                pattern.every(index => markedSquares.includes(index))
            );
        }

        function updateProgressDisplay() {
            const currentPlayerData = gameState.players[currentPlayer];
            const totalMarked = currentPlayerData && currentPlayerData.markedSquares ? currentPlayerData.markedSquares.length : 0;
            
            // Update progress text - no percentage for traditional bingo
            document.getElementById('myProgress').textContent = `Squares Marked: ${totalMarked}/25`;
            
            // Update progress bar
            const progress = Math.round((totalMarked / 25) * 100);
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function updateLeaderboard() {
            const players = Object.entries(gameState.players);
            
            // Sort players by progress (number of marked squares)
            const sortedPlayers = players.sort((a, b) => {
                const aProgress = a[1].markedSquares ? a[1].markedSquares.length : 0;
                const bProgress = b[1].markedSquares ? b[1].markedSquares.length : 0;
                return bProgress - aProgress;
            });

            const leaderboard = document.getElementById('leaderboard');
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (sortedPlayers.length > 1) {
                leaderboard.style.display = 'block';
                leaderboardList.innerHTML = '';
                
                sortedPlayers.forEach(([playerName, playerData], index) => {
                    const progress = playerData.markedSquares ? playerData.markedSquares.length : 0;
                    const isReady = playerData.isReady || false;
                    
                    const leaderItem = document.createElement('div');
                    leaderItem.className = 'leader-item';
                    
                    let rankIcon = '';
                    if (index === 0 && progress > 0) rankIcon = 'ü•á';
                    else if (index === 1 && progress > 0) rankIcon = 'ü•à';
                    else if (index === 2 && progress > 0) rankIcon = 'ü•â';
                    else rankIcon = `${index + 1}.`;
                    
                    const isCurrentPlayer = playerName === currentPlayer;
                    const nameStyle = isCurrentPlayer ? 'font-weight: bold; color: #4CAF50;' : '';
                    const readyIcon = isReady ? ' ‚úÖ' : '';
                    
                    leaderItem.innerHTML = `
                        <span class="leader-rank">${rankIcon}</span>
                        <span style="${nameStyle}">${playerName}${readyIcon}</span>
                        <span>${progress} squares</span>
                    `;
                    
                    leaderboardList.appendChild(leaderItem);
                });
            } else {
                leaderboard.style.display = 'none';
            }
        }

        function updateUI() {
            // Update players list
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            const players = Object.entries(gameState.players);
            players.forEach(([playerName, playerData]) => {
                const playerDiv = document.createElement('div');
                let className = 'player-status';
                
                if (playerName === currentPlayer) {
                    className += ' current-player';
                } else {
                    className += ' opponent';
                }
                
                if (playerData.isWinner) {
                    className += ' winner';
                }
                
                playerDiv.className = className;
                
                const progress = playerData.markedSquares ? playerData.markedSquares.length : 0;
                const isReady = playerData.isReady || false;
                const readyIcon = isReady ? ' ‚úÖ' : '';
                
                playerDiv.innerHTML = `
                    <div>${playerData.isWinner ? `üëë ${playerName}` : playerName}${readyIcon}</div>
                    <div class="player-progress">${progress} squares</div>
                `;
                
                playersList.appendChild(playerDiv);
            });

            // Update grid
            const squares = document.querySelectorAll('.bingo-square');
            squares.forEach((square, index) => {
                square.classList.remove('my-mark', 'opponent-mark', 'both-marked');
                
                // Safe check for current player data
                const currentPlayerData = gameState.players[currentPlayer];
                let myMark = currentPlayerData && currentPlayerData.markedSquares && currentPlayerData.markedSquares.includes(index) || false;
                let opponentMark = false;
                let opponentNames = [];
                
                // Check opponents
                for (const [playerName, playerData] of Object.entries(gameState.players)) {
                    if (playerName !== currentPlayer && playerData && playerData.markedSquares && playerData.markedSquares.includes(index)) {
                        opponentMark = true;
                        opponentNames.push(playerName);
                    }
                }
                
                // Apply visual feedback
                if (myMark && opponentMark) {
                    square.classList.add('both-marked');
                    square.title = `You and ${opponentNames.join(', ')} marked this`;
                } else if (myMark) {
                    square.classList.add('my-mark');
                    square.title = 'You marked this';
                } else if (opponentMark) {
                    square.classList.add('opponent-mark');
                    square.title = `${opponentNames.join(', ')} marked this`;
                } else {
                    square.title = bingoSquares[index];
                }
            });

            // Update progress display
            updateProgressDisplay();
            
            // Update leaderboard
            updateLeaderboard();

            // Update status and controls based on game phase
            const statusText = document.getElementById('statusText');
            const gameControls = document.querySelector('.game-controls');
            
            // Add "I'm Done" button if in collection phase and not ready
            const currentPlayerData = gameState.players[currentPlayer];
            const isReady = currentPlayerData && currentPlayerData.isReady;
            
            if (gameState.gamePhase === 'collection' && !isReady) {
                let doneButton = document.getElementById('doneButton');
                if (!doneButton) {
                    doneButton = document.createElement('button');
                    doneButton.id = 'doneButton';
                    doneButton.className = 'btn btn-small';
                    doneButton.textContent = "‚úÖ I'm Done";
                    doneButton.onclick = markPlayerReady;
                    gameControls.insertBefore(doneButton, gameControls.querySelector('.status'));
                }
            } else {
                // Remove done button if it exists
                const doneButton = document.getElementById('doneButton');
                if (doneButton) {
                    doneButton.remove();
                }
            }

            // Update status based on game phase
            if (gameState.winner && gameState.gamePhase === 'finished') {
                if (gameState.winner === currentPlayer) {
                    statusText.innerHTML = 'üéâ BINGO! You won with 5 in a row!';
                } else {
                    statusText.innerHTML = `üèÜ ${gameState.winner} won with BINGO!`;
                }
            } else if (gameState.gamePhase === 'analysis') {
                statusText.innerHTML = 'üîç Analyzing results...<br><small>Checking for BINGO patterns</small>';
            } else if (gameState.gamePhase === 'collection') {
                const playerCount = Object.keys(gameState.players).length;
                const readyCount = gameState.playersReady ? gameState.playersReady.length : 0;
                
                if (isReady) {
                    statusText.innerHTML = `‚úÖ You're ready! Waiting for others...<br><small>${readyCount}/${playerCount} players ready</small>`;
                } else if (playerCount === 1) {
                    statusText.innerHTML = '‚è≥ Waiting for other players...<br><small>Share your game code!</small>';
                } else {
                    statusText.innerHTML = `üéÆ Mark squares for things you've done<br><small>Click "I'm Done" when finished (${readyCount}/${playerCount} ready)</small>`;
                }
            } else {
                statusText.innerHTML = 'Game completed!';
            }

            if (debugMode) updateDebugInfo();
        }

        // Message Functions
        function showWinMessage() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('winMessage').style.display = 'block';
        }

        function showLoseMessage() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('loseMessage').style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('winMessage').style.display = 'none';
            document.getElementById('loseMessage').style.display = 'none';
        }

        // Game Control Functions
        function resetGame() {
            gameState.players = {};
            gameState.winner = null;
            gameState.gamePhase = 'collection';
            gameState.playersReady = [];
            gameState.players[currentPlayer] = { 
                markedSquares: [], 
                isWinner: false, 
                joinedAt: Date.now(),
                isReady: false
            };
            
            saveGameState();
            updateUI();
            hideMessages();
            showNotification('üîÑ Game reset!');
        }

        function leaveGame() {
            if (firebaseListener) {
                firebaseListener();
                firebaseListener = null;
            }
            
            // Remove player from Firebase
            if (window.firebaseReady && currentGameId && gameState.players[currentPlayer]) {
                delete gameState.players[currentPlayer];
                
                // Remove from ready list
                if (gameState.playersReady && gameState.playersReady.includes(currentPlayer)) {
                    const index = gameState.playersReady.indexOf(currentPlayer);
                    gameState.playersReady.splice(index, 1);
                }
                
                // If no players left, remove the entire game
                if (Object.keys(gameState.players).length === 0) {
                    const gameRef = window.firebaseRef(window.firebaseDB, `bingo-games/${currentGameId}`);
                    window.firebaseRemove(gameRef);
                } else {
                    saveGameState();
                }
            }
            
            // Reset and go back to setup
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('gameSetup').style.display = 'block';
            goBackToModeSelection();
            
            currentPlayer = null;
            currentGameId = null;
            showNotification('üëã Left the game');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-convert game code to uppercase
            const gameCodeInput = document.getElementById('gameCode');
            if (gameCodeInput) {
                gameCodeInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }

            // Enter key handlers
            const createPlayerNameInput = document.getElementById('createPlayerName');
            if (createPlayerNameInput) {
                createPlayerNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') createGame();
                });
            }

            const joinPlayerNameInput = document.getElementById('joinPlayerName');
            if (joinPlayerNameInput) {
                joinPlayerNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') document.getElementById('gameCode').focus();
                });
            }

            if (gameCodeInput) {
                gameCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') joinGame();
                });
            }
        });

        // Initialize when page loads
        if (!window.firebaseReady) {
            // Firebase will call initializeGame when ready
            console.log('‚è≥ Waiting for Firebase...');
        }
    </script>
</body>
</html>
